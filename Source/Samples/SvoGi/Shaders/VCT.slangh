#pragma once
#include "Samples/SvoGi/Shaders/VoxelizationTracing.slangh"

struct VCTHitInfo : ITracingHitInfo {
    float4 Color = {};
    RayDesc Ray = {};
    float tCur = 0.0f;

    [mutating]
    bool deal_if_hitted(uint32_t parentNode, uint32_t childShift, int32_t scale, Stack stack, float childScale, float t){
        return false;
    }
}


float4 cone_tracing(in RayDesc ray, in float3 aperture, in VoxelizationMeta bufVoxelMeta) {
    float4 finalColor = {};

    float tEnter = 0.0f;
    float tLeave = 0.0f;
    if (!intersect_ray_with_AABB(ray.Origin, ray.Direction, vec3(1.0), vec3(2.0), tEnter, tLeave)) {
        return returnColor;
    }

    int32_t curLevel = bufVoxelMeta.CurLevel;

    VCTHitInfo hitInfo = {};
    hitInfo.Ray = ray;

    while(htInfo.tCur < tLeave && t.Color.a < 0.99f) {
        hitInfo.Ray.Origin = hitInfo.Ray.Origin + ray.Direction * htInfo.tCur;
        hitInfo.Ray.TMax = hitInfo.tCur + g_NodeSteps[curLevel];
        trace_sparse_voxel_ray(ray, bufSvoNodeNext, curLevel, bufVoxelMeta.CellDim, hitInfo);
        curLevel = std::max(--curLevel, 0);
    }
    return finalColor;
}
